
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Lê Văn Đông</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Lê Văn Đông</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"<strong></strong> Khái niệm nào sau đây mô tả đúng nhất về Trí tuệ nhân tạo (AI)?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Khoa học về robot","Khoa học về lập trình máy tính","Khoa học và công nghệ tạo ra các cỗ máy thông minh","Khoa học về xử lí dữ liệu lớn"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"<strong></strong> Tại sao việc nghiên cứu Trí tuệ nhân tạo lại quan trọng trong thời đại hiện nay?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Để thay thế hoàn toàn con người trong mọi công việc","Để phát triển các hệ thống có khả năng học hỏi, giải quyết vấn đề và đưa ra quyết định như con người","Để tạo ra các trò chơi điện tử phức tạp hơn","Để giúp máy tính tiêu thụ ít năng lượng hơn"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong></strong> Ứng dụng nào sau đây KHÔNG phải là ứng dụng của Trí tuệ nhân tạo trong đời sống?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Xe tự lái","Hệ thống nhận dạng khuôn mặt","Máy tính bảng thông thường","Trợ lí ảo (ví dụ: Siri, Google Assistant)"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"<strong></strong> Trí tuệ nhân tạo đóng vai trò gì trong lĩnh vực y tế?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Hoàn toàn thay thế bác sĩ trong việc chẩn đoán bệnh","Hỗ trợ chẩn đoán bệnh, phân tích dữ liệu y tế, phát triển thuốc mới","Chỉ dùng để quản lí hồ sơ bệnh án","Giúp bệnh nhân tự điều trị tại nhà"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong></strong> Thiết bị nào sau đây dùng để kết nối các máy tính trong một mạng cục bộ (LAN) và chuyển tiếp dữ liệu dựa trên địa chỉ MAC?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Modem","Router","Switch","Hub"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"<strong></strong> Thiết bị nào chịu trách nhiệm chuyển đổi tín hiệu số từ máy tính thành tín hiệu tương tự để truyền qua đường dây điện thoại và ngược lại?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Switch","Router","Repeater","Modem"],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"<strong></strong> Một Router khác gì so với một Switch trong chức năng truyền dữ liệu giữa các mạng?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Router chỉ hoạt động ở tầng vật lí, còn Switch ở tầng liên kết dữ liệu","Router dùng để kết nối các mạng khác nhau, còn Switch dùng để kết nối các thiết bị trong cùng một mạng","Router không có khả năng định tuyến, còn Switch có","Router và Switch có chức năng hoàn toàn giống nhau"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong></strong> Chức năng chính của việc chia sẻ tài nguyên trên mạng là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Tăng tốc độ truy cập Internet","Cho phép nhiều người dùng cùng truy cập và sử dụng dữ liệu, phần cứng chung","Giảm thiểu nguy cơ virus máy tính","Tự động sao lưu dữ liệu"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong></strong> Để chia sẻ một thư mục trên mạng, người dùng cần có quyền truy cập nào đối với thư mục đó?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Chỉ quyền đọc","Quyền đọc và ghi","Quyền quản trị viên","Tùy thuộc vào thiết lập chia sẻ của người dùng"],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"<strong></strong> Khi bạn chia sẻ một máy in trên mạng, lợi ích chính mà bạn nhận được là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Máy in hoạt động nhanh hơn","Tiết kiệm chi phí mua nhiều máy in cho từng người dùng","Bảo mật dữ liệu tốt hơn","Máy in có thể in từ bất kỳ đâu trên thế giới"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong></strong> Quy tắc nào sau đây là quan trọng nhất trong việc giao tiếp và ứng xử trong không gian mạng?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Luôn sử dụng biệt danh","Tôn trọng người khác","Chia sẻ mọi thông tin cá nhân","Chỉ giao tiếp với người quen"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong></strong> Ưu điểm nào sau đây KHÔNG phải là ưu điểm của việc giao tiếp trong không gian mạng?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Kết nối với mọi người trên toàn cầu","Trao đổi thông tin nhanh chóng","Bảo mật thông tin tuyệt đối","Chia sẻ kiến thức và kinh nghiệm"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về ứng dụng của AI và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"AI có thể giúp dự báo thời tiết chính xác hơn.","is_correct":true},{"statement":"AI được sử dụng trong hệ thống gợi ý sản phẩm của các trang thương mại điện tử.","is_correct":true},{"statement":"AI chỉ được ứng dụng trong các phòng thí nghiệm và không có ứng dụng thực tế.","is_correct":false},{"statement":"Robot công nghiệp là một ví dụ về ứng dụng AI trong sản xuất.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về ứng dụng của AI và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hệ thống dịch thuật tự động là một ứng dụng của AI.","is_correct":true},{"statement":"AI có thể được sử dụng để phát hiện gian lận trong giao dịch tài chính.","is_correct":true},{"statement":"AI chỉ có thể làm những gì đã được lập trình sẵn mà không thể học hỏi từ dữ liệu mới.","is_correct":false},{"statement":"Công nghệ nhận diện giọng nói được hỗ trợ bởi AI.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về tác động của AI đến xã hội và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"AI có thể dẫn đến một số vấn đề về quyền riêng tư và đạo đức.","is_correct":true},{"statement":"AI giúp tăng năng suất lao động ở nhiều ngành nghề.","is_correct":true},{"statement":"Việc phát triển AI không gây ra bất kỳ lo ngại nào về an ninh mạng.","is_correct":false},{"statement":"AI chỉ có thể thực hiện các công việc lặp đi lặp lại, không có khả năng sáng tạo.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về khả năng tiềm tàng của AI và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Một hệ thống AI có khả năng tự học hỏi có thể thích nghi và cải thiện hiệu suất theo thời gian.","is_correct":true},{"statement":"AI có thể được sử dụng để phát triển các loại vũ khí tự động mà không cần sự can thiệp của con người.","is_correct":true},{"statement":"Khả năng ra quyết định của AI luôn hoàn hảo và không bao giờ mắc lỗi.","is_correct":false},{"statement":"AI có thể tạo ra tác phẩm nghệ thuật hoặc âm nhạc độc đáo.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về thiết bị mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hub là thiết bị khuếch đại tín hiệu và truyền dữ liệu tới tất cả các cổng.","is_correct":true},{"statement":"Card mạng (NIC) là một thành phần phần mềm giúp máy tính kết nối vào mạng.","is_correct":false},{"statement":"Access Point (AP) dùng để tạo ra mạng Wi-Fi không dây.","is_correct":true},{"statement":"Firewall là một thiết bị mạng có chức năng chính là định tuyến các gói tin.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về thiết bị mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Cáp Ethernet là thiết bị dùng để kết nối hai mạng khác nhau.","is_correct":false},{"statement":"Repeater là thiết bị giúp khuếch đại tín hiệu mạng để truyền đi xa hơn.","is_correct":true},{"statement":"Router chỉ có thể kết nối các thiết bị có dây, không hỗ trợ Wi-Fi.","is_correct":false},{"statement":"Switch là thiết bị có khả năng lọc gói tin và chuyển tiếp chúng đến đúng địa chỉ MAC.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về cách thức hoạt động của thiết bị mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Router quyết định đường đi tốt nhất cho các gói tin giữa các mạng khác nhau.","is_correct":true},{"statement":"Switch giúp giảm tắc nghẽn mạng bằng cách chỉ gửi dữ liệu đến cổng đích cụ thể.","is_correct":true},{"statement":"Modem cần thiết cho mọi kết nối mạng, kể cả mạng LAN nội bộ.","is_correct":false},{"statement":"Repeater được sử dụng để chuyển đổi các loại tín hiệu mạng khác nhau (ví dụ: từ cáp quang sang cáp đồng).","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về việc lựa chọn và cấu hình thiết bị mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Để mở rộng phạm vi mạng Wi-Fi trong một ngôi nhà lớn, việc sử dụng Repeater là một giải pháp hiệu quả.","is_correct":true},{"statement":"Khi xây dựng một mạng LAN nhỏ cho văn phòng, việc sử dụng Hub thay vì Switch sẽ tối ưu hơn về hiệu suất.","is_correct":false},{"statement":"Để kết nối một mạng gia đình với Internet, một Modem và một Router thường là các thiết bị cần thiết.","is_correct":true},{"statement":"Để đảm bảo an ninh cho mạng nội bộ, việc cấu hình Firewall trên Router là không cần thiết.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về giao thức mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giao thức HTTP được sử dụng để truyền tải siêu văn bản trên World Wide Web.","is_correct":true},{"statement":"Giao thức IP (Internet Protocol) có nhiệm vụ định danh duy nhất cho mỗi thiết bị trong mạng.","is_correct":false},{"statement":"FTP là giao thức dùng để gửi và nhận email.","is_correct":false},{"statement":"TCP là một giao thức đảm bảo truyền dữ liệu tin cậy, có kiểm soát lỗi.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về vai trò của các giao thức mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giao thức TCP/IP là bộ giao thức nền tảng của Internet.","is_correct":true},{"statement":"Khi truy cập một trang web, trình duyệt của bạn sử dụng giao thức HTTP để yêu cầu và nhận trang web từ máy chủ.","is_correct":true},{"statement":"Giao thức DNS (Domain Name System) giúp chuyển đổi địa chỉ IP thành tên miền dễ nhớ.","is_correct":false},{"statement":"Giao thức DHCP (Dynamic Host Configuration Protocol) cấp phát địa chỉ IP tĩnh cho các thiết bị trong mạng.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về việc áp dụng giao thức mạng trong tình huống cụ thể và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Khi cần truyền tải một tệp dữ liệu lớn một cách an toàn và có kiểm soát, việc sử dụng giao thức FTP hoặc SFTP là phù hợp.","is_correct":true},{"statement":"Nếu bạn muốn gửi email đến nhiều người nhận, giao thức SMTP sẽ được sử dụng để đẩy email từ máy khách đến máy chủ email.","is_correct":true},{"statement":"Để truy cập một máy chủ từ xa thông qua dòng lệnh một cách bảo mật, giao thức Telnet là lựa chọn tốt nhất.","is_correct":false},{"statement":"Trong một mạng gia đình, giao thức DHCP thường được Router sử dụng để tự động gán địa chỉ IP cho các thiết bị mới kết nối.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về giao tiếp và ứng xử trong không gian mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Sử dụng ngôn ngữ lịch sự, tôn trọng là một quy tắc ứng xử cơ bản trên mạng.","is_correct":true},{"statement":"Việc chia sẻ thông tin cá nhân của người khác mà không được sự đồng ý là hành vi vi phạm đạo đức.","is_correct":true},{"statement":"Luôn tin tưởng mọi thông tin mình đọc được trên mạng là đúng.","is_correct":false},{"statement":"Phản ứng tiêu cực hoặc công kích cá nhân khi bất đồng quan điểm là hành vi chấp nhận được trong không gian mạng.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về giao tiếp và ứng xử trong không gian mạng và xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Sử dụng biểu tượng cảm xúc (emoji) để thể hiện cảm xúc là cách giao tiếp phổ biến và được chấp nhận trên mạng.","is_correct":true},{"statement":"Mạo danh người khác trên mạng là một hành vi không thể chấp nhận được.","is_correct":true},{"statement":"Đăng tải những nội dung có tính chất phân biệt đối xử là hành vi bình thường trong không gian mạng.","is_correct":false},{"statement":"Luôn kiểm tra nguồn thông tin trước khi chia sẻ là một nguyên tắc quan trọng.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về những rủi ro khi giao tiếp trong không gian mạng và cách phòng tránh, xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Nguy cơ bị lộ thông tin cá nhân là một trong những rủi ro khi giao tiếp trên mạng.","is_correct":true},{"statement":"\"Phishing\" (lừa đảo trực tuyến) là một hình thức tấn công nhằm đánh cắp thông tin nhạy cảm của người dùng.","is_correct":true},{"statement":"Để an toàn, người dùng nên nhấp vào bất kỳ liên kết lạ nào gửi qua tin nhắn để kiểm tra nội dung.","is_correct":false},{"statement":"Quy tắc \"Tôn trọng\" trong không gian mạng có nghĩa là bạn không bao giờ được phép phản đối quan điểm của người khác.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Đọc các phát biểu sau về các tình huống cụ thể trong không gian mạng và cách ứng xử phù hợp, xác định chúng đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Khi chứng kiến hành vi bắt nạt trực tuyến, một hành động đúng đắn là báo cáo hành vi đó cho quản trị viên hoặc cơ quan có thẩm quyền.","is_correct":true},{"statement":"Nếu bạn nhận được một tin nhắn có nội dung xúc phạm hoặc gây khó chịu, cách tốt nhất là trả lời lại bằng những lời lẽ tương tự.","is_correct":false},{"statement":"Chia sẻ thông tin cá nhân của mình công khai trên các diễn đàn trực tuyến là một cách tốt để kết nối với mọi người.","is_correct":false},{"statement":"Khi tham gia vào một cuộc thảo luận trực tuyến, việc lắng nghe và cố gắng thấu hiểu quan điểm của người khác là biểu hiện của sự lịch sự.","is_correct":true}]},{"type":"essay","question":"<strong></strong> Nêu và phân tích một ví dụ cụ thể về cách AI đang thay đổi một lĩnh vực khoa học hoặc đời sống mà bạn biết.<br><em>Đáp án/Gợi ý:</em><br>Ví dụ: AI trong y tế. AI giúp chẩn đoán bệnh sớm hơn và chính xác hơn (ví dụ: phân tích hình ảnh X-quang, MRI để phát hiện ung thư), hỗ trợ các bác sĩ trong việc đưa ra quyết định điều trị, cá nhân hóa phác đồ điều trị cho từng bệnh nhân dựa trên dữ liệu di truyền và sức khỏe, và đẩy nhanh quá trình phát hiện và phát triển thuốc mới.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Thảo luận về những thách thức đạo đức và xã hội mà sự phát triển của Trí tuệ nhân tạo có thể mang lại.<br><em>Đáp án/Gợi ý:</em><br>Thách thức đạo đức và xã hội: 1. Quyền riêng tư và bảo mật dữ liệu: AI cần lượng lớn dữ liệu, tiềm ẩn nguy cơ lộ thông tin cá nhân. 2. Thiên vị (bias) trong AI: Dữ liệu huấn luyện có thể chứa định kiến, dẫn đến AI đưa ra quyết định không công bằng. 3. Mất việc làm: Tự động hóa bằng AI có thể thay thế một số công việc của con người. 4. Vấn đề trách nhiệm: Khi AI gây ra lỗi hoặc thiệt hại, ai sẽ chịu trách nhiệm? 5. An toàn và kiểm soát: Nguy cơ phát triển AI có khả năng tự chủ cao mà con người khó kiểm soát.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Giả sử bạn là một nhà phát triển AI, bạn sẽ thiết kế một ứng dụng AI nào để giải quyết một vấn đề cụ thể trong cộng đồng của bạn? Mô tả chi tiết về ứng dụng đó.<br><em>Đáp án/Gợi ý:</em><br>Ví dụ: Ứng dụng AI hỗ trợ quản lí rác thải thông minh. - Vấn đề: Cộng đồng có vấn đề về phân loại rác, thu gom rác không hiệu quả. - Ứng dụng: Thiết kế hệ thống AI sử dụng camera gắn trên thùng rác hoặc xe thu gom để nhận diện loại rác (hữu cơ, vô cơ, tái chế). Hệ thống AI cũng có thể dự đoán lượng rác phát sinh và tối ưu hóa lộ trình thu gom, thông báo cho người dân lịch trình thu gom và nhắc nhở phân loại rác qua ứng dụng di động. - Lợi ích: Nâng cao hiệu quả phân loại và thu gom rác, giảm ô nhiễm môi trường, tiết kiệm chi phí vận hành.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> So sánh sự khác biệt cơ bản giữa trí tuệ con người và trí tuệ nhân tạo. Theo bạn, liệu AI có thể đạt được cảm xúc và ý thức như con người hay không?<br><em>Đáp án/Gợi ý:</em><br>Sự khác biệt: Trí tuệ con người có khả năng sáng tạo, cảm xúc, ý thức, tư duy trừu tượng, học hỏi từ kinh nghiệm và bối cảnh phức tạp. Trí tuệ nhân tạo hiện tại chủ yếu là mô phỏng trí thông minh của con người thông qua thuật toán, xử lí dữ liệu, học máy để giải quyết các vấn đề cụ thể, thường thiếu khả năng hiểu biết sâu sắc, cảm xúc và ý thức. Khả năng đạt được cảm xúc và ý thức: Đây là một câu hỏi triết học và khoa học đang được tranh luận. Hiện tại, AI chưa thể có cảm xúc và ý thức thực sự như con người. Mặc dù AI có thể mô phỏng cảm xúc hoặc đưa ra phản ứng 'có vẻ' cảm xúc, nhưng đó chỉ là kết quả của các thuật toán được lập trình, không phải là sự trải nghiệm nội tại. Việc AI có thể đạt được cảm xúc và ý thức trong tương lai vẫn là một thách thức lớn và cần có những tiến bộ đột phá về lý thuyết và công nghệ.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Nêu sự khác biệt cơ bản giữa giao thức TCP và UDP. Trong trường hợp nào thì nên ưu tiên sử dụng TCP hơn UDP và ngược lại?<br><em>Đáp án/Gợi ý:</em><br>Sự khác biệt: - TCP (Transmission Control Protocol): Là giao thức có định hướng kết nối, tin cậy, có kiểm soát lỗi và luồng dữ liệu, đảm bảo dữ liệu đến đích đúng thứ tự và không bị mất mát. - UDP (User Datagram Protocol): Là giao thức không định hướng kết nối, không tin cậy, không có kiểm soát lỗi và luồng. Dữ liệu được gửi đi nhanh chóng nhưng không đảm bảo đến đích hay đúng thứ tự. Khi nào dùng TCP: Ưu tiên dùng TCP khi cần truyền dữ liệu tin cậy, toàn vẹn và đúng thứ tự như duyệt web (HTTP), gửi email (SMTP), truyền tệp (FTP). Khi nào dùng UDP: Ưu tiên dùng UDP khi tốc độ quan trọng hơn độ tin cậy, và một số mất mát dữ liệu nhỏ có thể chấp nhận được như truyền video/audio trực tuyến, gọi điện thoại qua Internet (VoIP), game online.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Trình bày vai trò của giao thức HTTP và HTTPS trong việc truy cập các trang web. Tại sao HTTPS lại được khuyến khích sử dụng hơn HTTP?<br><em>Đáp án/Gợi ý:</em><br>Vai trò của HTTP (Hypertext Transfer Protocol): Là giao thức nền tảng để truyền tải dữ liệu siêu văn bản trên World Wide Web. Khi bạn gõ địa chỉ một trang web, trình duyệt của bạn sử dụng HTTP để gửi yêu cầu đến máy chủ và nhận lại nội dung trang web. Vai trò của HTTPS (Hypertext Transfer Protocol Secure): Là phiên bản bảo mật của HTTP, sử dụng mã hóa SSL/TLS để bảo vệ dữ liệu truyền tải giữa trình duyệt và máy chủ. Lý do HTTPS được khuyến khích hơn HTTP: 1. Bảo mật dữ liệu: Mã hóa thông tin, ngăn chặn việc đánh cắp hoặc thay đổi dữ liệu bởi bên thứ ba. 2. Toàn vẹn dữ liệu: Đảm bảo dữ liệu không bị thay đổi trong quá trình truyền tải. 3. Xác thực: Xác minh tính hợp lệ của máy chủ, giúp người dùng biết mình đang kết nối với trang web chính xác, tránh các trang web giả mạo. 4. Tối ưu hóa SEO: Các công cụ tìm kiếm (như Google) ưu tiên xếp hạng các trang web sử dụng HTTPS.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Giải thích cách mà hệ thống DNS hoạt động để giúp người dùng truy cập các trang web bằng tên miền thay vì địa chỉ IP.<br><em>Đáp án/Gợi ý:</em><br>Cách hoạt động của DNS (Domain Name System): 1. Khi người dùng nhập tên miền (ví dụ: google.com) vào trình duyệt, máy tính sẽ gửi yêu cầu đến máy chủ DNS cục bộ (thường là của nhà cung cấp dịch vụ Internet). 2. Máy chủ DNS cục bộ kiểm tra xem có lưu trữ địa chỉ IP tương ứng cho tên miền đó trong bộ nhớ cache không. Nếu có, nó sẽ trả về địa chỉ IP ngay lập tức. 3. Nếu không, máy chủ DNS cục bộ sẽ bắt đầu quá trình truy vấn phân cấp: Gửi yêu cầu đến máy chủ DNS gốc (Root DNS server), sau đó đến máy chủ DNS TLD (Top-Level Domain server - ví dụ: .com), rồi đến máy chủ DNS có thẩm quyền (Authoritative DNS server) quản lí tên miền cụ thể (ví dụ: google.com). 4. Máy chủ DNS có thẩm quyền sẽ trả về địa chỉ IP tương ứng với tên miền đó. 5. Địa chỉ IP này được gửi về máy tính của người dùng và lưu vào bộ nhớ cache. Trình duyệt sau đó sử dụng địa chỉ IP này để kết nối trực tiếp đến máy chủ web và tải trang.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Mô tả các bước cơ bản diễn ra khi bạn gửi một email từ máy tính của mình đến một người bạn, liên hệ đến các giao thức mạng liên quan.<br><em>Đáp án/Gợi ý:</em><br>Các bước gửi email: 1. Soạn và gửi email: Bạn soạn email trong một ứng dụng email (client) và nhấp nút gửi. 2. Giao thức SMTP (Simple Mail Transfer Protocol) gửi email đi: Ứng dụng email của bạn sử dụng SMTP để đẩy email từ máy tính của bạn đến máy chủ gửi email (Outgoing Mail Server) của bạn. 3. Máy chủ gửi email chuyển tiếp: Máy chủ gửi email của bạn tìm kiếm địa chỉ email của người nhận. Nếu người nhận thuộc cùng một nhà cung cấp dịch vụ email, email sẽ được chuyển trực tiếp. Nếu không, máy chủ sẽ sử dụng DNS để tìm máy chủ nhận email của người bạn. 4. Email được chuyển đến máy chủ nhận: Máy chủ gửi email của bạn sử dụng SMTP để chuyển tiếp email đến máy chủ nhận email (Incoming Mail Server) của người bạn. 5. Giao thức POP3/IMAP nhận email: Người bạn của bạn sử dụng ứng dụng email để kiểm tra hòm thư. Ứng dụng này sử dụng POP3 (Post Office Protocol 3) để tải email về máy tính hoặc IMAP (Internet Message Access Protocol) để đồng bộ hóa và đọc email trực tiếp từ máy chủ.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Bạn đang làm việc trong một nhóm dự án nhỏ. Nêu các bước cần thiết để thiết lập chia sẻ một thư mục chứa tài liệu dự án để tất cả các thành viên trong nhóm có thể truy cập và chỉnh sửa.<br><em>Đáp án/Gợi ý:</em><br>Các bước thiết lập chia sẻ thư mục trên Windows: 1. Tạo thư mục chứa tài liệu dự án trên một máy tính (máy chủ chia sẻ). 2. Nhấp chuột phải vào thư mục đó, chọn 'Properties' (Thuộc tính). 3. Chọn tab 'Sharing' (Chia sẻ), sau đó nhấp vào 'Advanced Sharing...' (Chia sẻ nâng cao...). 4. Đánh dấu chọn 'Share this folder' (Chia sẻ thư mục này). 5. Nhấp vào 'Permissions' (Quyền hạn), sau đó thêm người dùng hoặc nhóm 'Everyone' (Mọi người). 6. Cấp quyền 'Full Control' (Toàn quyền) hoặc 'Change' (Thay đổi) cho những người được phép chỉnh sửa, và 'Read' (Đọc) nếu chỉ muốn xem. 7. Đảm bảo cài đặt chia sẻ mạng (Network and Sharing Center) cho phép khám phá mạng và chia sẻ tệp/máy in. 8. Thông báo địa chỉ mạng của thư mục chia sẻ (ví dụ: \\\\TenMayChu\\TenThuMucChiaSe) cho các thành viên trong nhóm.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Trình bày một số lợi ích và rủi ro khi chia sẻ tài nguyên trên mạng cục bộ (LAN) trong môi trường văn phòng. Làm thế nào để giảm thiểu các rủi ro đó?<br><em>Đáp án/Gợi ý:</em><br>Lợi ích: - Tiết kiệm chi phí: Chia sẻ máy in, máy quét, ổ đĩa lưu trữ, phần mềm. - Tăng cường cộng tác: Nhiều người cùng truy cập và chỉnh sửa tài liệu dự án. - Quản lí tập trung: Dễ dàng sao lưu, cập nhật dữ liệu chung. - Tăng năng suất: Truy cập nhanh chóng các tài nguyên cần thiết. Rủi ro: - Bảo mật: Dữ liệu nhạy cảm có thể bị truy cập trái phép nếu không cấu hình quyền chặt chẽ. - Lây nhiễm virus/malware: Nếu một máy tính bị nhiễm, virus có thể lan truyền qua các tệp chia sẻ. - Mất mát dữ liệu: Lỗi hệ thống trên máy chủ chia sẻ có thể ảnh hưởng đến tất cả người dùng. - Hiệu suất mạng: Quá nhiều truy cập vào tài nguyên chia sẻ có thể làm chậm mạng. Cách giảm thiểu rủi ro: - Thiết lập quyền truy cập chặt chẽ, chỉ cấp quyền cần thiết cho từng người dùng/nhóm. - Sử dụng mật khẩu mạnh cho các tài khoản truy cập chia sẻ. - Cài đặt phần mềm diệt virus/phần mềm độc hại trên tất cả các máy tính và máy chủ. - Sao lưu dữ liệu định kì. - Giám sát hoạt động truy cập tài nguyên chia sẻ.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Trong ngữ cảnh chia sẻ tài nguyên trên mạng, giải thích sự khác biệt giữa quyền 'Đọc' (Read) và 'Đọc/Ghi' (Read/Write) đối với một thư mục được chia sẻ. Nêu ví dụ cụ thể về trường hợp sử dụng phù hợp cho mỗi loại quyền.<br><em>Đáp án/Gợi ý:</em><br>Sự khác biệt: - Quyền 'Đọc' (Read): Cho phép người dùng xem nội dung tệp, mở tệp, sao chép tệp từ thư mục chia sẻ về máy của mình, nhưng không thể tạo tệp mới, sửa đổi tệp hiện có, xóa tệp hoặc thư mục con trong thư mục chia sẻ. - Quyền 'Đọc/Ghi' (Read/Write): Cho phép người dùng thực hiện tất cả các hành động của quyền 'Đọc', đồng thời có thể tạo tệp mới, chỉnh sửa nội dung tệp hiện có, xóa tệp và thư mục con trong thư mục chia sẻ. Ví dụ: - Trường hợp sử dụng quyền 'Đọc': Một thư mục chứa các quy định, chính sách công ty hoặc tài liệu tham khảo mà tất cả nhân viên cần xem nhưng không được phép chỉnh sửa. Ví dụ: 'Tài liệu Nội quy Công ty'. - Trường hợp sử dụng quyền 'Đọc/Ghi': Một thư mục dùng chung cho nhóm dự án, nơi các thành viên cần cộng tác, tạo và chỉnh sửa các tệp liên quan đến dự án. Ví dụ: 'Dự án Marketing Q3'.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null},{"type":"essay","question":"<strong></strong> Gia đình bạn có nhiều máy tính và một máy in. Bạn muốn tất cả các máy tính trong nhà đều có thể in qua máy in này mà không cần kết nối trực tiếp. Trình bày cách bạn có thể thiết lập việc chia sẻ máy in này.<br><em>Đáp án/Gợi ý:</em><br>Các bước thiết lập chia sẻ máy in: 1. Kết nối máy in với một máy tính trong nhà (máy chủ in) và đảm bảo máy in hoạt động bình thường trên máy tính đó. 2. Trên máy chủ in, vào 'Control Panel' (Bảng điều khiển) -&gt; 'Devices and Printers' (Thiết bị và Máy in) hoặc 'Settings' (Cài đặt) -&gt; 'Bluetooth &amp; devices' (Bluetooth &amp; thiết bị) -&gt; 'Printers &amp; scanners' (Máy in &amp; máy quét). 3. Nhấp chuột phải vào máy in muốn chia sẻ, chọn 'Printer properties' (Thuộc tính máy in). 4. Chọn tab 'Sharing' (Chia sẻ), sau đó đánh dấu vào 'Share this printer' (Chia sẻ máy in này) và đặt tên chia sẻ (ví dụ: 'MayInGiaDinh'). 5. (Tùy chọn) Chọn 'Change Sharing Options' (Thay đổi tùy chọn chia sẻ) trong 'Network and Sharing Center' (Trung tâm mạng và chia sẻ) và bật 'File and printer sharing' (Chia sẻ tệp và máy in) cho mạng nhà bạn. 6. Trên các máy tính khác trong nhà: a. Mở 'Devices and Printers' hoặc 'Printers &amp; scanners'. b. Chọn 'Add a printer or scanner' (Thêm máy in hoặc máy quét). c. Chọn 'The printer that I want isn't listed' (Máy in tôi muốn không có trong danh sách). d. Chọn 'Select a shared printer by name' (Chọn máy in được chia sẻ theo tên) và nhập đường dẫn mạng của máy in (ví dụ: \\\\TenMayChuIn\\MayInGiaDinh, trong đó 'TenMayChuIn' là tên máy tính đang chia sẻ máy in). e. Hoàn tất cài đặt trình điều khiển (nếu cần). Bây giờ tất cả các máy tính trong nhà có thể in qua máy in đã chia sẻ.","main_question":null,"questionImage":null,"mappedType":"essay","answer":null}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":3,"tf":4,"sa":0,"essay":3,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbx0wjtV7_6YRNN_qtus4nArp20_NkLjfTxHb127Lu0wFKvm5v1MtqURFiW5zUAQBXCX/exec";
            const correctExamCode = "L4YBRZ";
            const teacherApiKey = "AIzaSyDzpJyodrQYlL0_OmSq4k3snugEgphM6IE";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = response.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    
